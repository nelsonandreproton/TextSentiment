<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Details - Text Sentiment Extraction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .content-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .text-content {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        .meta-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }
        .action-buttons {
            position: sticky;
            top: 1rem;
            z-index: 100;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .back-link {
            text-decoration: none;
            color: #6c757d;
            transition: color 0.2s;
        }
        .back-link:hover {
            color: #495057;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-image"></i> Text Sentiment Extraction</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/records"><i class="bi bi-list-ul"></i> All Records</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- Back Navigation -->
        <div class="row mb-3">
            <div class="col-12">
                <a href="/records" class="back-link">
                    <i class="bi bi-arrow-left"></i> Back to All Records
                </a>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading record details...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" style="display: none;">
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> <span id="errorText"></span>
            </div>
        </div>

        <!-- Record Content -->
        <div id="recordContent" style="display: none;">
            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8">
                    <!-- Title -->
                    <div class="mb-4">
                        <h1 class="display-6 text-primary" id="recordTitle"></h1>
                    </div>

                    <!-- Extracted Text -->
                    <div class="content-section">
                        <h4 class="mb-3">
                            <i class="bi bi-file-text"></i> Extracted Text
                        </h4>
                        <div class="text-content" id="recordText"></div>
                    </div>

                    <!-- Search Similar -->
                    <div class="content-section">
                        <h5 class="mb-3">
                            <i class="bi bi-search"></i> Find Similar Records
                        </h5>
                        <p class="text-muted mb-3">Use the content from this record to find similar texts:</p>
                        <button class="btn btn-outline-primary" onclick="searchSimilar()">
                            <i class="bi bi-search"></i> Search Similar Content
                        </button>
                        <div id="similarResults" class="mt-3"></div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <div class="action-buttons">
                        <!-- Action Buttons -->
                        <div class="meta-card mb-3">
                            <h6 class="mb-3">Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="copyToClipboard()">
                                    <i class="bi bi-clipboard"></i> Copy Text
                                </button>
                                <button class="btn btn-outline-secondary" onclick="printRecord()">
                                    <i class="bi bi-printer"></i> Print
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteRecord()">
                                    <i class="bi bi-trash"></i> Delete Record
                                </button>
                            </div>
                        </div>

                        <!-- Statistics -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="wordCount">0</div>
                                    <div>Words</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <div class="stat-number" id="charCount">0</div>
                                    <div>Characters</div>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata -->
                        <div class="meta-card">
                            <h6 class="mb-3">Record Information</h6>
                            <div class="mb-2">
                                <strong>ID:</strong> <span id="recordId"></span>
                            </div>
                            <div class="mb-2">
                                <strong>Image File:</strong><br>
                                <small class="text-muted" id="imageFilename"></small>
                            </div>
                            <div class="mb-2">
                                <strong>Created:</strong><br>
                                <span id="createdDate"></span><br>
                                <small class="text-muted" id="createdTime"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Success
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="successMessage">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const recordId = {{ record_id }};
        let recordData = null;

        // Load record on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadRecord();
        });

        async function loadRecord() {
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            const recordContent = document.getElementById('recordContent');

            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            recordContent.style.display = 'none';

            try {
                const response = await fetch(`/api/records/${recordId}`);
                const data = await response.json();

                if (data.success) {
                    recordData = data.record;
                    displayRecord();
                    recordContent.style.display = 'block';
                } else {
                    throw new Error(data.message || 'Record not found');
                }
            } catch (error) {
                document.getElementById('errorText').textContent = error.message;
                errorMessage.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayRecord() {
            const record = recordData;
            const createdDate = new Date(record.created_at);

            // Update page title
            document.title = `${record.title} - Text Sentiment Extraction`;

            // Fill in the content
            document.getElementById('recordTitle').textContent = record.title;
            document.getElementById('recordText').innerHTML = record.extracted_text.replace(/\n/g, '<br>');
            document.getElementById('recordId').textContent = record.id;
            document.getElementById('imageFilename').textContent = record.image_filename;
            document.getElementById('createdDate').textContent = createdDate.toLocaleDateString();
            document.getElementById('createdTime').textContent = createdDate.toLocaleTimeString();
            document.getElementById('wordCount').textContent = record.word_count.toLocaleString();
            document.getElementById('charCount').textContent = record.character_count.toLocaleString();
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(recordData.extracted_text);
                showSuccess('Text copied to clipboard successfully!');
            } catch (error) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = recordData.extracted_text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Text copied to clipboard successfully!');
            }
        }

        function printRecord() {
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${recordData.title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .meta { background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; }
                        .content { margin: 20px 0; }
                        @media print {
                            body { margin: 20px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${recordData.title}</h1>
                    <div class="meta">
                        <strong>Record ID:</strong> ${recordData.id}<br>
                        <strong>Created:</strong> ${new Date(recordData.created_at).toLocaleString()}<br>
                        <strong>Source Image:</strong> ${recordData.image_filename}<br>
                        <strong>Word Count:</strong> ${recordData.word_count}<br>
                        <strong>Character Count:</strong> ${recordData.character_count}
                    </div>
                    <div class="content">
                        <h3>Extracted Text:</h3>
                        ${recordData.extracted_text.replace(/\n/g, '<br>')}
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        async function deleteRecord() {
            if (!confirm(`Are you sure you want to delete the record "${recordData.title}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/records/${recordId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    showSuccess('Record deleted successfully! Redirecting to records list...');
                    setTimeout(() => {
                        window.location.href = '/records';
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Failed to delete record');
                }
            } catch (error) {
                alert('Error deleting record: ' + error.message);
            }
        }

        async function searchSimilar() {
            const button = event.target;
            const originalText = button.innerHTML;
            const resultsDiv = document.getElementById('similarResults');

            button.innerHTML = '<i class="bi bi-spinner-border"></i> Searching...';
            button.disabled = true;

            try {
                const formData = new FormData();
                formData.append('query', recordData.extracted_text);

                const response = await fetch('/search', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    if (data.results.length > 0) {
                        let resultsHtml = '<h6 class="mt-3">Similar Records:</h6>';
                        data.results.forEach(result => {
                            if (result.id !== recordData.id) { // Don't show the current record
                                resultsHtml += `
                                    <div class="card mb-2">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="card-title">
                                                        <a href="/records/${result.id}" class="text-decoration-none">
                                                            ${result.title}
                                                        </a>
                                                    </h6>
                                                    <p class="card-text small text-muted">${result.preview}</p>
                                                </div>
                                                <span class="badge bg-primary">${(result.similarity_score * 100).toFixed(1)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        resultsDiv.innerHTML = resultsHtml;
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-info mt-3">No similar records found.</div>';
                    }
                } else {
                    throw new Error(data.message || 'Search failed');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger mt-3">Error: ${error.message}</div>`;
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }
    </script>
</body>
</html>